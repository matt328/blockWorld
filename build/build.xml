<?xml version="1.0" encoding="UTF-8"?>
<project name="BlockWorld" default="jar" basedir="..">

	<property file="${basedir}/build/build.properties" />
	<property name="build.dir" value="${basedir}/dist" />
	<property name="src.dir" value="${basedir}/src" />
	<property name="asset.dir" value="${basedir}/assets" />
	<property name="jMonkey.dir" value="${basedir}/jMonkey" />
	<property name="jMonkey.lib.dir" value="${jMonkey.dir}/lib" />

	<property name="dist.dir" value="${basedir}/dist" />
	<property name="dist.lib.dir" value="${basedir}/dist/lib" />

	<property name="stage.dir" value="${build.dir}/stage" />
	<property name="classes.dir" value="${stage.dir}/classes" />

	<property name="assets.jar.name" value="assets.jar" />

	<property name="main.class" value="org.blockworld.main.MyGame" />

	<property name="main.jar.name" value="${ant.project.name}.jar" />
	<property name="dist.jar" value="${dist.dir}/${main.jar.name}" />

	<property name="launch4j.home.dir" value="E:/dev/java/launch4j" />
	<property name="launch4j.lib.dir" value="${launch4j.home.dir}/lib" />

	<property name="lib.dir" value="${basedir}/lib" />

	<property name="src.infoplist" value="${basedir}/etc/macosx/Info.plist" />
	<property name="src.osx-stub" value="${basedir}/etc/macosx/osx-stub" />
	<property name="src.osx-icns" value="${basedir}/etc/macosx/osx-icon.icns" />
	<property name="dist.infoplist" value="${dist.dir}/Info.plist" />

	<property name="run.jvmargs" value="-Xdock:name=BlockWorld" />

	<path id="launch4j.path">
		<fileset dir="${launch4j.lib.dir}">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="${launch4j.home.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="class.path">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="jar.class.path">
		<path refid="class.path" />
		<pathelement location="${dist.lib.dir}/${assets.jar.name}" />
	</path>

	<target name="clean">
		<delete dir="${dist.dir}" />
	</target>

	<target name="init">
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${stage.dir}" />
		<mkdir dir="${dist.lib.dir}" />
	</target>

	<target name="compile" depends="init">
		<javac destdir="${stage.dir}" source="1.6">
			<src path="${src.dir}" />
			<exclude name="**/_*.java" />
			<classpath refid="class.path" />
		</javac>
	</target>

	<target name="jar-assets" depends="init">
		<jar basedir="${asset.dir}" jarfile="${dist.lib.dir}/${assets.jar.name}" />
	</target>

	<target name="copy-libs" depends="init">
		<copy todir="${dist.lib.dir}" flatten="true">
			<fileset dir="${jMonkey.dir}" id="jMonkey.libs">
				<include name="**/*.jar" />
			</fileset>
		</copy>
	</target>

	<target name="jar" depends="compile, copy-libs, jar-assets">
		<pathconvert property="mf.classpath" pathsep=" " refid="jar.class.path">
			<mapper type="flatten" />
			<map from="" to="lib/" />
		</pathconvert>
		<jar basedir="${stage.dir}" jarfile="${build.dir}/${main.jar.name}">
			<manifest>
				<attribute name="Main-Class" value="${main.class}" />
				<attribute name="Class-Path" value="${mf.classpath}" />
			</manifest>
		</jar>
		<delete dir="${stage.dir}" />
	</target>

	<target name="linux-launcher" depends="jar">
		<echo>Linux Launcher Creation</echo>
		<echo file="${ant.project.name}.sh">#!/bin/sh
java -jar ${main.jar.name}
        </echo>
		<zip destfile="${dist.dir}/${ant.project.name}-Linux.zip">
			<zipfileset file="${ant.project.name}.sh" filemode="755" prefix="" />
			<zipfileset file="${dist.jar}" prefix="" />
			<zipfileset dir="${dist.dir}/lib" prefix="lib/" />
		</zip>
		<delete file="${ant.project.name}.sh" />
	</target>

	<target name="launch4j-exe" depends="jar">
		<echo>Windows EXE Creation</echo>
		<taskdef classname="net.sf.launch4j.ant.Launch4jTask" classpath="${launch4j.path}" name="launch4j" />
		<launch4j>
			<config jar="${dist.jar}" outfile="${dist.dir}/${ant.project.name}.exe" errTitle="${ant.project.name}" headertype="gui" chdir="." customProcName="true">
				<singleInstance mutexName="${main.class}" />
				<jre minVersion="1.5.0" maxheapsize="512" />
			</config>
		</launch4j>
		<zip destfile="${dist.dir}/${ant.project.name}-Windows.zip">
			<zipfileset file="${dist.dir}/${ant.project.name}.exe" prefix="" />
			<zipfileset dir="${dist.dir}/lib" prefix="lib/" />
		</zip>
		<delete file="${dist.dir}/${ant.project.name}.exe" />
	</target>

	<target name="mac-app" depends="jar">
		<echo>MacOSX Application Creation</echo>
		<copy file="${src.infoplist}" tofile="${dist.infoplist}">
			<filterchain>
				<replacestring from="$${main.class}" to="${main.class}" />
				<replacestring from="$${run.jvmargs}" to="${run.jvmargs}" />
				<replacestring from="$${application.title}" to="${ant.project.name}" />
			</filterchain>
		</copy>
		<zip destfile="${dist.dir}/${ant.project.name}-MacOSX.zip">
			<zipfileset file="${src.osx-stub}" filemode="755" fullpath="${ant.project.name}.app/Contents/MacOS/JavaApplicationStub" />
			<zipfileset file="${dist.infoplist}" fullpath="${ant.project.name}.app/Contents/Info.plist" />
			<zipfileset file="${src.osx-icns}" fullpath="${ant.project.name}.app/Contents/Resources/GenericApp.icns" />
			<zipfileset file="${dist.jar}" prefix="${ant.project.name}.app/Contents/Resources/Java" />
			<zipfileset dir="${dist.dir}/lib" prefix="${ant.project.name}.app/Contents/Resources/Java/lib" />
		</zip>
		<delete file="${dist.infoplist}" />
	</target>

	<target name="all">
		<antcall target="linux-launcher" />
		<antcall target="launch4j-exe" />
		<antcall target="mac-app" />
	</target>

</project>